---
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
    name: elastic-istio
spec:
    version: 7.13.0
    http:
        tls:
            selfSignedCertificate:
                disabled: true
    nodeSets:
        - name: default
          count: 3
          podTemplate:
              metadata:
                  annotations:
                      traffic.sidecar.istio.io/includeInboundPorts: '*'
                      traffic.sidecar.istio.io/excludeOutboundPorts: '9300'
                      traffic.sidecar.istio.io/excludeInboundPorts: '9300'
              spec:
                  automountServiceAccountToken: true
---
apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
    name: elastic-istio
spec:
    version: 7.13.0
    count: 1
    elasticsearchRef:
        name: elastic-istio
    config:
        server.basePath: /kb
        server.rewriteBasePath: false
        server.publicBaseUrl: http://a6f7074ae7c084df7b881d63d78b29df-1020100293.us-west-2.elb.amazonaws.com/kb
    http:
        tls:
            selfSignedCertificate:
                disabled: true
    podTemplate:
        spec:
            automountServiceAccountToken: true
---
apiVersion: apm.k8s.elastic.co/v1
kind: ApmServer
metadata:
    name: elastic-istio
spec:
    version: 7.13.0
    count: 1
    elasticsearchRef:
        name: elastic-istio
    http:
        tls:
            selfSignedCertificate:
                disabled: true
    podTemplate:
        metadata:
            annotations:
                sidecar.istio.io/rewriteAppHTTPProbers: 'true'
        spec:
            automountServiceAccountToken: true
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
    name: kb
spec:
    hosts:
        - '*'
    gateways:
        - bookinfo-gateway
    http:
        - match:
              - uri:
                    prefix: /kb
          rewrite:
              uri: ' '
          route:
              - destination:
                    host: elastic-istio-kb-http
                    port:
                        number: 5601

